{"version":"0.3.0","body":"function main(workbook: ExcelScript.Workbook) {\n    const sheetEntradas = workbook.getWorksheet(\"ENTRADAS\");\n    const sheetRetiradas = workbook.getWorksheet(\"RETIRADAS\");\n    const sheetHistorico = workbook.getWorksheet(\"HISTÓRICO\");\n\n    // Verificar se as planilhas existem\n    if (!sheetEntradas) {\n        console.log(\"Planilha 'ENTRADAS' não encontrada!\");\n        return;\n    }\n    if (!sheetRetiradas) {\n        console.log(\"Planilha 'RETIRADAS' não encontrada!\");\n        return;\n    }\n    if (!sheetHistorico) {\n        console.log(\"Planilha 'HISTÓRICO' não encontrada!\");\n        return;\n    }\n\n    // Obter dados das planilhas\n    const ultimaLinhaEntradas = sheetEntradas.getUsedRange().getRowCount();\n    const ultimaLinhaRetiradas = sheetRetiradas.getUsedRange().getRowCount();\n\n    const dadosEntradas = sheetEntradas.getRange(`A5:L${ultimaLinhaEntradas}`).getValues();\n    const dadosRetiradas = sheetRetiradas.getRange(`A5:P${ultimaLinhaRetiradas}`).getValues();\n\n    // Índices das colunas\n    const ENT_DATA = 1, ENT_DESCRICAO = 3, ENT_CATEGORIA = 4, ENT_QUANTIDADE = 5, ENT_TAMANHO = 6;\n    const RET_DATA = 1, RET_DESCRICAO = 3, RET_CATEGORIA = 4, RET_QUANTIDADE = 5, RET_TAMANHO = 6, RET_STATUS = 14;\n\n    // Identificar meses\n    const mesesSet = new Set<string>();\n\n    // Coletar meses das ENTRADAS\n    for (let i = 0; i < dadosEntradas.length; i++) {\n        const valorOriginal = dadosEntradas[i][ENT_DATA];\n        const dataEntrada = converterParaData(valorOriginal);\n        if (dataEntrada) {\n            console.log(`ENTRADA - Valor original: ${valorOriginal} | Data convertida: ${dataEntrada.toLocaleDateString('pt-BR')} | Ano: ${dataEntrada.getFullYear()} | Mês: ${dataEntrada.getMonth() + 1}`);\n            const chaveData = `${dataEntrada.getFullYear()}-${String(dataEntrada.getMonth() + 1).padStart(2, '0')}`;\n            mesesSet.add(chaveData);\n        }\n    }\n\n    // Coletar meses das RETIRADAS\n    for (let i = 0; i < dadosRetiradas.length; i++) {\n        const valorOriginal = dadosRetiradas[i][RET_DATA];\n        const dataRetirada = converterParaData(valorOriginal);\n        if (dataRetirada) {\n            console.log(`RETIRADA - Valor original: ${valorOriginal} | Data convertida: ${dataRetirada.toLocaleDateString('pt-BR')} | Ano: ${dataRetirada.getFullYear()} | Mês: ${dataRetirada.getMonth() + 1}`);\n            const chaveData = `${dataRetirada.getFullYear()}-${String(dataRetirada.getMonth() + 1).padStart(2, '0')}`;\n            mesesSet.add(chaveData);\n        }\n    }\n\n    // Ordenar os meses cronologicamente\n    const mesesOrdenados = Array.from(mesesSet).sort();\n\n    if (mesesOrdenados.length === 0) {\n        console.log(\"Nenhuma data válida encontrada nos dados!\");\n        return;\n    }\n\n    console.log(`Meses identificados: ${mesesOrdenados.join(\", \")}`);\n\n    // Estrutura de dados\n    interface ItemHistorico {\n        categoria: string;\n        descricao: string;\n        tamanho: string | number;\n        dadosPorMes: Map<string, { entradas: number; saidas: number }>;\n    }\n\n    const mapaHistorico = new Map<string, ItemHistorico>();\n\n    // Processar ENTRADAS\n    for (let i = 0; i < dadosEntradas.length; i++) {\n        const dataEntrada = converterParaData(dadosEntradas[i][ENT_DATA]);\n        if (!dataEntrada) continue;\n\n        const categoria = dadosEntradas[i][ENT_CATEGORIA]?.toString() || \"\";\n        const descricao = dadosEntradas[i][ENT_DESCRICAO]?.toString() || \"\";\n        const tamanhoRaw = dadosEntradas[i][ENT_TAMANHO];\n        const tamanho = typeof tamanhoRaw === 'boolean' ? \"\" : (tamanhoRaw || \"\");\n        const quantidade = Number(dadosEntradas[i][ENT_QUANTIDADE]) || 0;\n\n        if (!categoria && !descricao) continue;\n\n        const chave = `${categoria}|${descricao}|${tamanho}`;\n\n        if (!mapaHistorico.has(chave)) {\n            mapaHistorico.set(chave, {\n                categoria: categoria,\n                descricao: descricao,\n                tamanho: tamanho,\n                dadosPorMes: new Map()\n            });\n        }\n\n        const item = mapaHistorico.get(chave)!;\n        const mesChave = `${dataEntrada.getFullYear()}-${String(dataEntrada.getMonth() + 1).padStart(2, '0')}`;\n\n        if (!item.dadosPorMes.has(mesChave)) {\n            item.dadosPorMes.set(mesChave, { entradas: 0, saidas: 0 });\n        }\n        item.dadosPorMes.get(mesChave)!.entradas += quantidade;\n    }\n\n    // Processar RETIRADAS\n    for (let i = 0; i < dadosRetiradas.length; i++) {\n        const dataRetirada = converterParaData(dadosRetiradas[i][RET_DATA]);\n        if (!dataRetirada) continue;\n\n        const categoria = dadosRetiradas[i][RET_CATEGORIA]?.toString() || \"\";\n        const descricao = dadosRetiradas[i][RET_DESCRICAO]?.toString() || \"\";\n        const tamanhoRaw = dadosRetiradas[i][RET_TAMANHO];\n        const tamanho = typeof tamanhoRaw === 'boolean' ? \"\" : (tamanhoRaw || \"\");\n        const quantidade = Number(dadosRetiradas[i][RET_QUANTIDADE]) || 0;\n\n        if (!categoria && !descricao) continue;\n\n        const chave = `${categoria}|${descricao}|${tamanho}`;\n\n        if (!mapaHistorico.has(chave)) {\n            mapaHistorico.set(chave, {\n                categoria: categoria,\n                descricao: descricao,\n                tamanho: tamanho,\n                dadosPorMes: new Map()\n            });\n        }\n\n        const item = mapaHistorico.get(chave)!;\n        const mesChave = `${dataRetirada.getFullYear()}-${String(dataRetirada.getMonth() + 1).padStart(2, '0')}`;\n\n        if (!item.dadosPorMes.has(mesChave)) {\n            item.dadosPorMes.set(mesChave, { entradas: 0, saidas: 0 });\n        }\n        item.dadosPorMes.get(mesChave)!.saidas += quantidade;\n    }\n\n    // Calcular saldos\n    Array.from(mapaHistorico.values()).forEach((item) => {\n        let saldoAcumulado = 0;\n        for (const mesChave of mesesOrdenados) {\n            const dados = item.dadosPorMes.get(mesChave);\n            if (dados) saldoAcumulado += dados.entradas - dados.saidas;\n        }\n    });\n\n    // Montar matriz final\n    const dadosHistorico: (string | number | boolean)[][] = [];\n    Array.from(mapaHistorico.values()).forEach((item) => {\n        const linha: (string | number | boolean)[] = [\n            item.categoria,\n            item.descricao,\n            item.tamanho\n        ];\n        let saldoAcumulado = 0;\n        for (const mesChave of mesesOrdenados) {\n            const dados = item.dadosPorMes.get(mesChave) || { entradas: 0, saidas: 0 };\n            saldoAcumulado += dados.entradas - dados.saidas;\n            linha.push(dados.entradas, dados.saidas, saldoAcumulado);\n        }\n        dadosHistorico.push(linha);\n    });\n\n    // Cabeçalhos e escrita\n    const nomesMeses = [\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\"];\n    const rangeHeaderLimpar = sheetHistorico.getRange(\"E4:ZZ4\");\n    rangeHeaderLimpar.clear();\n\n    let colunaAtual = 4;\n    for (const mesChave of mesesOrdenados) {\n        const partes = mesChave.split(\"-\");\n        const ano = Number(partes[0]);\n        const mes = Number(partes[1]);\n        const ultimoDiaMes = new Date(ano, mes, 0);\n        const dataFormatada = ultimoDiaMes.toLocaleDateString(\"pt-BR\");\n\n        const rangeMes = sheetHistorico.getRangeByIndexes(3, colunaAtual, 1, 3);\n        rangeMes.merge();\n        rangeMes.setValue(dataFormatada);\n\n        sheetHistorico.getRangeByIndexes(4, colunaAtual, 1, 1).setValue(\"Entradas\");\n        sheetHistorico.getRangeByIndexes(4, colunaAtual + 1, 1, 1).setValue(\"Saídas\");\n        sheetHistorico.getRangeByIndexes(4, colunaAtual + 2, 1, 1).setValue(\"Saldo\");\n        colunaAtual += 3;\n    }\n\n    const rangeHistorico = sheetHistorico.getRange(\"B6:ZZ1000\");\n    rangeHistorico.clear();\n\n    if (dadosHistorico.length > 0) {\n        const numColunas = 3 + (mesesOrdenados.length * 3);\n        const rangeDestino = sheetHistorico.getRangeByIndexes(5, 1, dadosHistorico.length, numColunas);\n        rangeDestino.setValues(dadosHistorico);\n    }\n\n    const dataAtual = new Date();\n    const dataFormatada = dataAtual.toLocaleDateString(\"pt-BR\") + \" \" +\n        dataAtual.toLocaleTimeString(\"pt-BR\", { hour: '2-digit', minute: '2-digit' });\n    sheetHistorico.getRange(\"C2\").setValue(dataFormatada);\n\n    console.log(`Histórico atualizado com ${dadosHistorico.length} itens e ${mesesOrdenados.length} meses.`);\n}\n\n\n// Tratar datas\nfunction converterParaData(valor: unknown): Date | null {\n    if (valor === null || valor === undefined) return null;\n    if (typeof valor === \"boolean\") return null;\n\n    // Se já for Date válido\n    if (valor instanceof Date && !isNaN(valor.getTime())) {\n        return new Date(valor.getFullYear(), valor.getMonth(), valor.getDate());\n    }\n\n    // Se for número: tratar como Excel Date\n    if (typeof valor === \"number\" && !isNaN(valor)) {\n        let serial = Math.floor(valor);\n\n        if (serial <= 0) return null;\n\n        if (serial > 60) serial = serial - 1;\n\n        const excelEpochUtc = Date.UTC(1899, 11, 31);\n        const ms = excelEpochUtc + serial * 86400000;\n\n        const d = new Date(ms);\n        return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());\n    }\n\n    // String: dd/mm/yyyy, d/m/yyyy\n    if (typeof valor === \"string\") {\n        const s = valor.trim();\n        // Primeiro: padrão brasileiro com barra\n        const partes = s.split(\"/\");\n        if (partes.length === 3) {\n            const dia = parseInt(partes[0], 10);\n            const mes = parseInt(partes[1], 10) - 1;\n            let ano = parseInt(partes[2], 10);\n            if (isNaN(dia) || isNaN(mes) || isNaN(ano)) {\n                // fallback para parse nativo\n            } else {\n                // ano com 2 dígitos\n                if (ano < 100) ano += ano < 50 ? 2000 : 1900;\n                const dt = new Date(ano, mes, dia);\n                if (!isNaN(dt.getTime())) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());\n            }\n        }\n        return null;\n\n    }\n\n    return null;\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}