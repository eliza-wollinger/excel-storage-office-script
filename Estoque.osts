{"version":"0.3.0","body":"function main(workbook: ExcelScript.Workbook) {\n    const sheetEntradas = workbook.getWorksheet(\"ENTRADAS\");\n    const sheetRetiradas = workbook.getWorksheet(\"RETIRADAS\");\n    const sheetEstoque = workbook.getWorksheet(\"ESTOQUE\");\n\n    // Verificar se as abas existem\n    if (!sheetEntradas) {\n        console.log(\"Planilha 'ENTRADAS' não encontrada!\");\n        return;\n    }\n    if (!sheetRetiradas) {\n        console.log(\"Planilha 'RETIRADAS' não encontrada!\");\n        return;\n    }\n    if (!sheetEstoque) {\n        console.log(\"Planilha 'ESTOQUE' não encontrada!\");\n        console.log(\"Planilhas disponíveis:\");\n        workbook.getWorksheets().forEach(ws => console.log(\"  - \" + ws.getName()));\n        return;\n    }\n\n    // Obter dados das planilhas\n    const ultimaLinhaEntradas = sheetEntradas.getUsedRange().getRowCount();\n    const ultimaLinhaRetiradas = sheetRetiradas.getUsedRange().getRowCount();\n\n    const dadosEntradas = sheetEntradas.getRange(`A5:L${ultimaLinhaEntradas}`).getValues();\n    const dadosRetiradas = sheetRetiradas.getRange(`A5:P${ultimaLinhaRetiradas}`).getValues();\n\n    // Índices das colunas - ENTRADAS\n    const ENT_DESCRICAO = 3;      // Coluna D - Descrição\n    const ENT_CATEGORIA = 4;      // Coluna E - Categoria\n    const ENT_QUANTIDADE = 5;     // Coluna F - Quantidade\n    const ENT_TAMANHO = 6;        // Coluna G - Tamanho\n    const ENT_VALOR_UNITARIO = 7; // Coluna H - Valor Unitário\n    const ENT_TIPO = 8;           // Coluna I - Tipo\n\n    // Índices das colunas - RETIRADAS\n    const RET_DESCRICAO = 3;      // Coluna D - Descrição\n    const RET_CATEGORIA = 4;      // Coluna E - Categoria\n    const RET_QUANTIDADE = 5;     // Coluna F - Quantidade\n    const RET_TAMANHO = 6;        // Coluna G - Tamanho\n    const RET_STATUS = 14;        // Coluna  - Status\n\n    // Criar estrutura para agrupar dados\n    interface ItemEstoque {\n        categoria: string;\n        descricao: string;\n        tamanho: string | number;\n        unidade: string;\n        entradas: number;\n        saidas: number;\n    }\n\n    const mapaEstoque = new Map<string, ItemEstoque>();\n\n    // Processar ENTRADAS\n    for (let i = 0; i < dadosEntradas.length; i++) {\n        const categoria = dadosEntradas[i][ENT_CATEGORIA]?.toString() || \"\";\n        const descricao = dadosEntradas[i][ENT_DESCRICAO]?.toString() || \"\";\n        const tamanhoRaw = dadosEntradas[i][ENT_TAMANHO];\n        const tamanho = typeof tamanhoRaw === 'boolean' ? \"\" : (tamanhoRaw || \"\");\n        const quantidade = Number(dadosEntradas[i][ENT_QUANTIDADE]) || 0;\n\n        // Ignorar linhas vazias\n        if (!categoria && !descricao) continue;\n\n        // Criar chave única para filtrar dados: \n        // categoria+descrição+tamanho\n        const chave = `${categoria}|${descricao}|${tamanho}`;\n\n        if (!mapaEstoque.has(chave)) {\n            mapaEstoque.set(chave, {\n                categoria: categoria,\n                descricao: descricao,\n                tamanho: tamanho,\n                unidade: \"Un\",\n                entradas: 0,\n                saidas: 0\n            });\n        }\n\n        const item = mapaEstoque.get(chave);\n        if (item) {\n            item.entradas += quantidade;\n        }\n    }\n\n    // Processar RETIRADAS (apenas Status = \"Entregue\")\n    for (let i = 0; i < dadosRetiradas.length; i++) {\n        const status = dadosRetiradas[i][RET_STATUS]?.toString().trim().toLowerCase();\n\n        if (status === \"Entregue\") {\n            const categoria = dadosRetiradas[i][RET_CATEGORIA]?.toString() || \"\";\n            const descricao = dadosRetiradas[i][RET_DESCRICAO]?.toString() || \"\";\n            const tamanhoRaw = dadosRetiradas[i][RET_TAMANHO];\n            const tamanho = typeof tamanhoRaw === 'boolean' ? \"\" : (tamanhoRaw || \"\");\n            const quantidade = Number(dadosRetiradas[i][RET_QUANTIDADE]) || 0;\n\n            // Ignorar linhas vazias\n            if (!categoria && !descricao) continue;\n\n            const chave = `${categoria}|${descricao}|${tamanho}`;\n\n            if (mapaEstoque.has(chave)) {\n                const item = mapaEstoque.get(chave);\n                if (item) {\n                    item.saidas += quantidade;\n                }\n            }\n        }\n    }\n\n    // Converter Map para array (Numbers) e calcular saldo\n    const dadosEstoque: (string | number | boolean)[][] = [];\n\n    mapaEstoque.forEach((item) => {\n        const saldo = item.entradas - item.saidas;\n\n        dadosEstoque.push([\n            item.categoria,      // Coluna B\n            item.descricao,      // Coluna C\n            item.tamanho,        // Coluna D\n            \"\",                  // Coluna E (vazia)\n            item.unidade,        // Coluna F\n            item.entradas,       // Coluna G\n            item.saidas,         // Coluna H\n            saldo,               // Coluna I\n            \"\"                   // Coluna J (vazia)\n        ]);\n    });\n\n    // Ordenar por categoria e descrição\n    dadosEstoque.sort((a, b) => {\n        const catA = a[0].toString();\n        const catB = b[0].toString();\n        if (catA !== catB) return catA.localeCompare(catB);\n\n        const descA = a[1].toString();\n        const descB = b[1].toString();\n        return descA.localeCompare(descB);\n    });\n\n    // Limpar dados anteriores (B5:J1000)\n    const rangeEstoque = sheetEstoque.getRange(\"B5:J1000\");\n    rangeEstoque.clear();\n\n    // Inserir dados na planilha\n    if (dadosEstoque.length > 0) {\n        const rangeDestino = sheetEstoque.getRangeByIndexes(\n            4,  // linha 5 (índice 4)\n            1,  // coluna B (índice 1)\n            dadosEstoque.length,\n            9   // 9 colunas (B até J)\n        );\n        rangeDestino.setValues(dadosEstoque);\n    }\n\n    // Atualizar data (célula C2)\n    const dataAtual = new Date();\n    const dataFormatada = dataAtual.toLocaleDateString(\"pt-BR\") + \" \" +\n        dataAtual.toLocaleTimeString(\"pt-BR\", { hour: '2-digit', minute: '2-digit' });\n    sheetEstoque.getRange(\"C2\").setValue(dataFormatada);\n\n    console.log(`Estoque atualizado com ${dadosEstoque.length} itens.`);\n}","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}